{"version":3,"sources":["../src/listenDevices.js"],"names":["delay","listenDevicesPollingSkip","debug","events","setMaxListeners","listDevices","flatDevice","d","path","getFlatDevices","Set","map","getDeviceByPaths","find","paths","includes","lastDevices","poll","changeFound","currentDevices","newDevices","filter","length","emit","removeDevices","debouncedPoll","attachDetected","device","on","detachDetected","stop","cancel","removeListener"],"mappings":";;;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;kBAEe,UACbA,KADa,EAEbC,wBAFa,EAGbC,KAHa,EAOV;AACH,MAAMC,SAAS,sBAAf;AACAA,SAAOC,eAAP,CAAuB,CAAvB;;AAEA,MAAIC,cAAc,2BAAlB;;AAEA,MAAMC,aAAa,SAAbA,UAAa;AAAA,WAAKC,EAAEC,IAAP;AAAA,GAAnB;;AAEA,MAAMC,iBAAiB,SAAjBA,cAAiB;AAAA,wCAClB,IAAIC,GAAJ,CAAQ,4BAAaC,GAAb,CAAiB;AAAA,aAAKL,WAAWC,CAAX,CAAL;AAAA,KAAjB,CAAR,CADkB;AAAA,GAAvB;;AAIA,MAAMK,mBAAmB,SAAnBA,gBAAmB;AAAA,WACvBP,YAAYQ,IAAZ,CAAiB;AAAA,aAAKC,MAAMC,QAAN,CAAeT,WAAWC,CAAX,CAAf,CAAL;AAAA,KAAjB,CADuB;AAAA,GAAzB;;AAGA,MAAIS,cAAcP,gBAAlB;;AAEA,MAAMQ,OAAO,SAAPA,IAAO,GAAM;AACjB,QAAI,CAAChB,0BAAL,EAAiC;AAC/BC,YAAM,sCAAN;;AAEA,UAAIgB,cAAc,KAAlB;AACA,UAAMC,iBAAiBV,gBAAvB;AACA,UAAMW,aAAaD,eAAeE,MAAf,CAAsB;AAAA,eAAK,CAACL,YAAYD,QAAZ,CAAqBR,CAArB,CAAN;AAAA,OAAtB,CAAnB;;AAEA,UAAIa,WAAWE,MAAX,GAAoB,CAAxB,EAA2B;AACzBpB,cAAM,mBAAN,EAA2BkB,UAA3B;;AAEAf,sBAAc,2BAAd;AACAF,eAAOoB,IAAP,CAAY,KAAZ,EAAmBX,iBAAiBQ,UAAjB,CAAnB;;AAEAF,sBAAc,IAAd;AACD,OAPD,MAOO;AACLhB,cAAM,qBAAN;AACD;;AAED,UAAMsB,gBAAgBR,YAAYK,MAAZ,CACpB;AAAA,eAAK,CAACF,eAAeJ,QAAf,CAAwBR,CAAxB,CAAN;AAAA,OADoB,CAAtB;;AAIA,UAAIiB,cAAcF,MAAd,GAAuB,CAA3B,EAA8B;AAC5BpB,cAAM,uBAAN,EAA+BsB,aAA/B;;AAEArB,eAAOoB,IAAP,CAAY,QAAZ,EAAsBX,iBAAiBY,aAAjB,CAAtB;AACAnB,sBAAcA,YAAYgB,MAAZ,CACZ;AAAA,iBAAK,CAACG,cAAcT,QAAd,CAAuBT,WAAWC,CAAX,CAAvB,CAAN;AAAA,SADY,CAAd;;AAIAW,sBAAc,IAAd;AACD,OATD,MASO;AACLhB,cAAM,yBAAN;AACD;;AAED,UAAIgB,WAAJ,EAAiB;AACfF,sBAAcG,cAAd;AACD;AACF,KAtCD,MAsCO;AACLjB,YAAM,gCAAN;AACAuB;AACD;AACF,GA3CD;;AA6CA,MAAMA,gBAAgB,wBAASR,IAAT,EAAejB,KAAf,CAAtB;;AAEA,MAAM0B,iBAAiB,SAAjBA,cAAiB,SAAU;AAC/BxB,UAAM,sBAAN,EAA8ByB,MAA9B;;AAEAF;AACD,GAJD;AAKA,gBAAIG,EAAJ,CAAO,QAAP,EAAiBF,cAAjB;AACAxB,QAAM,uBAAN;;AAEA,MAAM2B,iBAAiB,SAAjBA,cAAiB,SAAU;AAC/B3B,UAAM,0BAAN,EAAkCyB,MAAlC;;AAEAF;AACD,GAJD;AAKA,gBAAIG,EAAJ,CAAO,QAAP,EAAiBC,cAAjB;AACA3B,QAAM,uBAAN;;AAEA,SAAO;AACL4B,UAAM,gBAAM;AACV5B,YACE,0EADF;AAGAuB,oBAAcM,MAAd;AACA,oBAAIC,cAAJ,CAAmB,QAAnB,EAA6BN,cAA7B;AACA,oBAAIM,cAAJ,CAAmB,QAAnB,EAA6BH,cAA7B;AACD,KARI;AASL1B;AATK,GAAP;AAWD,C","file":"listenDevices.js","sourcesContent":["// @flow\n\nimport EventEmitter from \"events\";\nimport usb from \"usb\";\nimport debounce from \"lodash/debounce\";\nimport getDevices from \"./getDevices\";\n\nexport default (\n  delay: number,\n  listenDevicesPollingSkip: () => boolean,\n  debug: (...any) => void\n): {\n  events: EventEmitter,\n  stop: () => void\n} => {\n  const events = new EventEmitter();\n  events.setMaxListeners(0);\n\n  let listDevices = getDevices();\n\n  const flatDevice = d => d.path;\n\n  const getFlatDevices = () => [\n    ...new Set(getDevices().map(d => flatDevice(d)))\n  ];\n\n  const getDeviceByPaths = paths =>\n    listDevices.find(d => paths.includes(flatDevice(d)));\n\n  let lastDevices = getFlatDevices();\n\n  const poll = () => {\n    if (!listenDevicesPollingSkip()) {\n      debug(\"Polling for added or removed devices\");\n\n      let changeFound = false;\n      const currentDevices = getFlatDevices();\n      const newDevices = currentDevices.filter(d => !lastDevices.includes(d));\n\n      if (newDevices.length > 0) {\n        debug(\"New device found:\", newDevices);\n\n        listDevices = getDevices();\n        events.emit(\"add\", getDeviceByPaths(newDevices));\n\n        changeFound = true;\n      } else {\n        debug(\"No new device found\");\n      }\n\n      const removeDevices = lastDevices.filter(\n        d => !currentDevices.includes(d)\n      );\n\n      if (removeDevices.length > 0) {\n        debug(\"Removed device found:\", removeDevices);\n\n        events.emit(\"remove\", getDeviceByPaths(removeDevices));\n        listDevices = listDevices.filter(\n          d => !removeDevices.includes(flatDevice(d))\n        );\n\n        changeFound = true;\n      } else {\n        debug(\"No removed device found\");\n      }\n\n      if (changeFound) {\n        lastDevices = currentDevices;\n      }\n    } else {\n      debug(\"Polling skipped, re-debouncing\");\n      debouncedPoll();\n    }\n  };\n\n  const debouncedPoll = debounce(poll, delay);\n\n  const attachDetected = device => {\n    debug(\"Device add detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"attach\", attachDetected);\n  debug(\"attach listener added\");\n\n  const detachDetected = device => {\n    debug(\"Device removal detected:\", device);\n\n    debouncedPoll();\n  };\n  usb.on(\"detach\", detachDetected);\n  debug(\"detach listener added\");\n\n  return {\n    stop: () => {\n      debug(\n        \"Stop received, removing listeners and cancelling pending debounced polls\"\n      );\n      debouncedPoll.cancel();\n      usb.removeListener(\"attach\", attachDetected);\n      usb.removeListener(\"detach\", detachDetected);\n    },\n    events\n  };\n};\n"]}